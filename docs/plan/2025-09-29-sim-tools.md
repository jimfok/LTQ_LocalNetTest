# Plan Log 2025-09-29
- spec:sim-tools
- branch: feature/sim-tools-requirements
- handoff commands: `./scripts/test.sh tests/sim-tools`

## Intent
- Land a join-first simulator harness so a CLI client can attach to the existing Defold **Create Room** flow for smoke coverage.
- Build lightweight simulators that reuse `src/network` modules to avoid drift from runtime logic.
- Capture CLI entrypoints under `scripts/` for downstream agents to drive from CI or remote shells while leaving runtime-facing collections untouched.

## Requirements Alignment (spec:sim-tools)
- Server simulator: drive the existing networking stack (`RoomServer`, `Discovery`) from an isolated CLI entrypoint without modifying `main` collections or HUD flows.
- Client simulator: reuse runtime protocol constants via CLI-only harnesses that never touch gameplay UI.
- Logging: provide structured TRACE events for automation and manual runs without depending on HUD mirroring.
- Scope guardrails: confine new automation to `src/sim-tools/`, `scripts/sim-tools/`, `tests/sim-tools/`, and docs; avoid changes under `main/` unless future specs require it.

## Roadmap Phasing
- **MVP (Join-first)**: Deliver a CLI join harness that latches onto the shipped Defold **Create Room** host. Success is the ability to run the game in one terminal, execute the join CLI in another, and watch the handshake complete without new server automation.
- **Follow-up (Standalone Create)**: Add a CLI host harness plus wrapper scripts so both sides of the flow can be exercised headlessly, independent of the Defold runtime.

## Tasks
### MVP: CLI Join harness wired to Defold Create Room
1. Update `docs/spec/sim-tools.md` to note the join-first scope and reference the in-game Create Room host as the current S1 coverage point.
2. Implement `src/sim-tools/simulation_join_room.lua` with deterministic loops suitable for CLI use, guarded behind `spec:sim-tools` comments.
3. Expose a shell wrapper `scripts/run-room-client.sh` (and supporting `scripts/sim-tools/simulation-join-room.sh`) that executes the join harness via LuaJIT and relays exit codes.
4. Document the two-terminal smoke in `docs/tasks/2025-09-29-sim-tools.md`: run the Defold Create Room flow in one terminal, run the join CLI in the other, confirm TRACE logs.

### Follow-up: Standalone CLI Create harness
5. Implement `src/sim-tools/simulation_created_room.lua` plus supporting harness helpers so a CLI host can stand in for the Defold build.
6. Add shell wrappers `scripts/run-room-server.sh` / `scripts/sim-tools/simulation-created-room.sh` and expand docs/tasks once the host harness is ready.
7. Extend behaviour specs and logging utilities (`tests/sim-tools/simulation_created_room_spec.lua`, shared logging sinks) after the join MVP lands to keep drift contained.

## Sub-requirements Breakdown
- **Simulator Harness Foundations**
  - Stabilise the networking primitives (`Discovery`, protocol constants from `RoomServer`) required for the join harness while documenting host-specific configuration (`--port`, `--room-id`) for the follow-up milestone.
  - Ensure lifecycle management covers startup, happy-path operation, and graceful shutdown (SIGINT) for the join harness now, leaving server loop orchestration to the standalone CLI host phase.
- **CLI Entry Points**
  - Define dedicated scripts under `scripts/sim-tools/` that translate CLI flags into harness parameters and propagate exit codes plus TRACE logs required by automation.
  - Provide the join wrapper (`scripts/run-room-client.sh`) during the MVP; server wrappers (`scripts/run-room-server.sh`) stay on the follow-up backlog.
- **Logging & Observability**
  - Emit the structured log families (`TRACE|sim.server|…`, `TRACE|sim.client|…`, `TRACE|sim-tools|…`) so downstream agents can assert behaviour without needing HUD hooks.
  - Provide CLI-facing sinks (stdout/jsonl) that remain fully contained in `src/sim-tools/`.
- **Runtime ↔ Simulator Isolation**
  - Keep simulator code paths out of `main/` collections and HUD scripts; simulators operate strictly through CLI entrypoints.
  - Capture terminology guidance inside docs/spec and CLI help text instead of touching runtime UI labels reserved for the shipped experience.
- **Test Coverage & Automation Hooks**
  - Expand `tests/sim-tools/` specs to cover client discovery/join flows and CLI duration/exit semantics described under Scenario S2 while queuing server accept loop coverage for the follow-up milestone.
  - Document automation expectations (duration caps, non-zero failures, log assertions) so CI agents can orchestrate self-tests without manual intervention.

## Implementation Breakdown by Artifact
### Simulator Harness Foundations ↔ Existing Code
- `src/network/discovery.lua`
  - Continue to lean on `Discovery:new`, `Discovery:listen`, `Discovery:broadcast_hello`, and `Discovery:receive` so the join harness can reuse the runtime discovery behaviour.
  - Surface deterministic broadcast configuration by letting the harness wrap `Discovery:set_on_hello` and `Discovery:close` and by threading CLI-derived overrides into `Discovery:new`.
- `src/network/room_server.lua`
  - For the MVP, treat the Defold Create Room flow as the authoritative host. The join harness should import protocol constants and JSON helpers without attempting to start its own TCP server yet.
  - Capture follow-up notes for CLI hosting under the standalone phase before altering `RoomServer` behaviours from the simulator side.
- `src/sim-tools/simulation_join_room.lua`
  - Build `run_simulation_join_room()` atop a new `build_client_harness(config)` helper so the Simulation-Join Room flow can reuse the scheduler loop, respect `--broadcast`, `--udp-port`, and `--duration`, and log `TRACE|sim.client|…` outcomes.
- **New artifacts for review (MVP scope)**
  - `src/sim-tools/harness/client.lua` exporting `build_client_harness(config, deps)` and `run_client_loop(harness_state)`.
  - `src/sim-tools/logging.lua` exporting `trace(component, action, status, fields)` so the join harness owns structured logging from day one.
- **Deferred artifacts (follow-up)**
  - `src/sim-tools/simulation_created_room.lua` and supporting `src/sim-tools/harness/server.lua` modules remain future work to enable a standalone CLI host.

### CLI Entry Points ↔ Existing Code
- `scripts/sim-tools/simulation-join-room.sh`
  - Replace placeholder `echo` lines with invocations of `lua src/sim-tools/cli.lua simulation-join-room …`, keeping the current TRACE comment headers so automation can detect pending vs. ready states.
  - Capture exit codes from the Lua harness and forward them to the shell so CI agents can act on failures.
- `scripts/run-room-client.sh`
  - Provide a developer-friendly wrapper that can boot the join harness directly or via headless Bob builds without depending on GUI collections.
- `scripts/test.sh` and `scripts/test-network.sh`
  - Keep these wrappers intact but document that `./scripts/test.sh tests/sim-tools` now exercises CLI parsing via stubbed argv arrays once the join harness lands.
- **Deferred artifacts (follow-up)**
  - `scripts/sim-tools/simulation-created-room.sh`, `scripts/run-room-server.sh`, and associated CLI host helpers will be revisited when the standalone create harness is in scope.

### Logging & Observability ↔ Existing Code
- `src/sim-tools/logging.lua`
  - Provide a shared helper (`trace(component, action, status, fields)`) that emits structured logs without coupling to runtime HUD state.
- `src/sim-tools/harness/*`
  - Accept optional sink callbacks (e.g. write-to-file, stdout collector) to keep simulator output configurable while remaining independent from `main` scene objects.
- **Deferred artifacts for follow-up**
  - `src/sim-tools/log_sinks.lua` defining CLI-focused sinks (stdout, jsonl file) that can be toggled per harness.
  - `tests/sim-tools/sim_tools_logging_spec.lua` asserting TRACE events are captured through these sinks without invoking UI helpers.

### Runtime ↔ Simulator Isolation Plan
- `main/` collections & scripts
  - Leave untouched; the existing HUD and button flows remain reserved for the actual game experience.
- `src/sim-tools/ui/` (optional future scope)
  - If lightweight simulator status displays are required later, place them under a new namespace to keep parity with the CLI while avoiding reuse of `main/ui` resources.
- Documentation touchpoints
  - Clarify in `docs/spec/sim-tools.md` and README simulator sections that the tooling operates headlessly/CLI-first and does not adjust game UI assets.
- **New artifacts for review**
  - `docs/tasks/2025-09-29-sim-tools.md` checklist entries to verify no runtime UI files change during simulator work.

### Test Coverage & Automation Hooks ↔ Existing Code
- `tests/sim-tools/simulation_join_room_spec.lua`
  - Verify that CLI parsing surfaces expected defaults and that discovery retries obey the harness scheduler cadence by injecting fake timers.
- `tests/support/network_context.lua`
  - Extend existing helpers to bootstrap the join harness for specs without duplicating setup logic.
- **Deferred artifacts (follow-up)**
  - `tests/sim-tools/simulation_created_room_spec.lua`, CLI host scenarios, and shared fakes for the server harness will be fleshed out once the standalone Create milestone begins.
  - `tests/support/sim_tools_fakes.lua` and broader CLI logging specs are tracked for the follow-up milestone to keep the MVP narrowly scoped.

## Spec / Plan / Task Audit (2025-09-29)
- **Spec alignment**: `docs/spec/sim-tools.md` now enforces CLI-only isolation for simulators and removes any requirement to rename HUD buttons under `main/ui`. Future edits must preserve the no-UI-touch rule and keep terminology scoped to docs/CLI strings.
- **Plan coverage**: The task list now splits the MVP join harness from the follow-up host work, with two-terminal smoke (Defold host + join CLI) called out explicitly for the first milestone.
- **Task tracker gaps**: `docs/tasks/2025-09-29-sim-tools.md` should keep the MVP checklist narrowed to the join harness, CLI wrapper, and smoke pair while capturing create-side work in a deferred section.
- **Follow-up**: Once harness modules land, mirror the audit summary into the task tracker notes to keep future agents aware of the isolation guardrails.

## Coordination
- Track day-to-day progress in `docs/tasks/2025-09-29-sim-tools.md` (spec:sim-tools).
