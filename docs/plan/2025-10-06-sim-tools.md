# Plan Log 2025-10-06
- spec:sim-tools
- branch: feature/sim-tools-requirements
- handoff commands: `./scripts/test.sh tests/sim-tools`

## Intent
- Provide local automation for `Create Room` and `Join Room` behaviours so developers can iterate without multiple physical devices.
- Build lightweight simulators that reuse `src/network` modules to avoid drift from runtime logic.
- Capture CLI entrypoints under `scripts/` for downstream agents to drive from CI or remote shells while leaving runtime-facing collections untouched.

## Requirements Alignment (spec:sim-tools)
- Server simulator: drive the existing networking stack (`RoomServer`, `Discovery`) from an isolated CLI entrypoint without modifying `main` collections or HUD flows.
- Client simulator: reuse runtime protocol constants via CLI-only harnesses that never touch gameplay UI.
- Logging: provide structured TRACE events for automation and manual runs without depending on HUD mirroring.
- Scope guardrails: confine new automation to `src/sim-tools/`, `scripts/sim-tools/`, `tests/sim-tools/`, and docs; avoid changes under `main/` unless future specs require it.

## Tasks
1. Draft `docs/spec/sim-tools.md` describing server and client simulators plus logging expectations.
2. Implement reusable simulator modules `src/sim-tools/simulation_created_room.lua` and `src/sim-tools/simulation_join_room.lua` with deterministic loops suitable for CLI use.
3. Expose shell wrappers `scripts/run-room-server.sh` and `scripts/run-room-client.sh` which execute the simulators using LuaJIT.
4. Add behaviour specs mirroring the modules in `tests/sim-tools/simulation_created_room_spec.lua` and `tests/sim-tools/simulation_join_room_spec.lua`, referencing `spec:sim-tools` for traceability.
5. Update `README.md` with quick-start instructions and link CLI usage to the spec.
6. Run `./scripts/test.sh tests/sim-tools` to verify the new suite.
7. Capture quick validation snippets (`./scripts/run-room-server.sh --duration 3`, `./scripts/run-room-client.sh --duration 3`) inside docs/tasks so shell execution remains the canonical smoke test.

## Sub-requirements Breakdown
- **Simulator Harness Foundations**
  - Stabilise the shared networking primitives (`RoomServer`, `Discovery`) needed by both harnesses and surface deterministic configuration inputs (`--port`, `--room-id`, `--duration`, `--udp-port`, `--broadcast`).
  - Ensure lifecycle management covers startup, happy-path operation, and graceful shutdown (SIGINT) for each simulator while staying aligned with the runtime flows documented in the spec scenarios.
- **CLI Entry Points**
  - Define dedicated scripts under `scripts/sim-tools/` that translate CLI flags into harness parameters and propagate exit codes plus TRACE logs required by automation.
  - Provide developer-friendly wrappers (`scripts/run-room-server.sh`, `scripts/run-room-client.sh`) that can boot the simulators directly or via headless Bob builds without depending on GUI collections.
- **Logging & Observability**
  - Emit the structured log families (`TRACE|sim.server|…`, `TRACE|sim.client|…`, `TRACE|sim-tools|…`) so downstream agents can assert behaviour without needing HUD hooks.
  - Provide CLI-facing sinks (stdout/jsonl) that remain fully contained in `src/sim-tools/`.
- **Runtime ↔ Simulator Isolation**
  - Keep simulator code paths out of `main/` collections and HUD scripts; simulators operate strictly through CLI entrypoints.
  - Capture terminology guidance inside docs/spec and CLI help text instead of touching runtime UI labels reserved for the shipped experience.
- **Test Coverage & Automation Hooks**
  - Expand `tests/sim-tools/` specs to cover server accept loops, client discovery/join flows, and CLI duration/exit semantics described under Scenarios S1–S3.
  - Document automation expectations (duration caps, non-zero failures, log assertions) so CI agents can orchestrate self-tests without manual intervention.

## Implementation Breakdown by Artifact
### Simulator Harness Foundations ↔ Existing Code
- `src/network/room_server.lua`
  - Reuse `RoomServer:new`, `RoomServer:start`, and `RoomServer:update` as the authoritative TCP lifecycle for the Simulation-Created Room flow; expose `RoomServer:set_on_join` in harness builders instead of reaching into `RoomServer.players` or `clients` directly.
  - Extend `respond` to emit structured logs by funnelling events through the upcoming `sim_tools_log.trace(component, action, status, fields)` helper so server joins can be asserted without scraping `print` output.
- `src/network/discovery.lua`
  - Continue to lean on `Discovery:new`, `Discovery:listen`, `Discovery:broadcast_hello`, and `Discovery:receive` to satisfy discovery requirements for both simulators.
  - Surface deterministic broadcast configuration by letting the harness wrap `Discovery:set_on_hello` and `Discovery:close` and by threading CLI-derived overrides into `Discovery:new`.
- `src/sim-tools/simulation_created_room.lua`
  - Refactor the `run_simulation_created_room()` entry point to delegate to a new `build_server_harness(config)` constructor that wires a `RoomServer` instance, `Discovery` listener, and scheduler loop while honouring `--port`, `--room-id`, and `--duration` flags.
  - Swap the bare `while true` loop for a reusable `run_until_done(loop_state)` helper that exits on duration expiry or SIGINT, using `socket.sleep` cadence sourced from config.
- `src/sim-tools/simulation_join_room.lua`
  - Mirror the server harness changes by calling `build_client_harness(config)` so the Simulation-Join Room flow can reuse the same scheduler loop and respect `--broadcast`, `--udp-port`, and `--duration`.
  - Promote the TODO around TCP join attempts into a dedicated `attempt_room_join(discovery_event, opts)` function that reuses `RoomServer` protocol constants and logs `TRACE|sim.client|join|…` outcomes.
- **New artifacts for review**
  - `src/sim-tools/harness/server.lua` exporting `build_server_harness(config, deps)` and `run_server_loop(harness_state)`.
  - `src/sim-tools/harness/client.lua` exporting `build_client_harness(config, deps)` and `run_client_loop(harness_state)`.
  - `src/sim-tools/logging.lua` exporting `trace(component, action, status, fields)` so both harnesses share structured logging semantics.

### CLI Entry Points ↔ Existing Code
- `scripts/sim-tools/simulation-created-room.sh` & `scripts/sim-tools/simulation-join-room.sh`
  - Replace placeholder `echo` lines with invocations of `lua src/sim-tools/cli.lua simulation-created-room …` / `simulation-join-room …`, keeping the current TRACE comment headers so automation can detect pending vs. ready states.
  - Capture exit codes from the Lua harness and forward them to the shell so CI agents can act on failures.
- `scripts/test.sh` and `scripts/test-network.sh`
  - Keep these wrappers intact but document that `./scripts/test.sh tests/sim-tools` now exercises CLI parsing via stubbed argv arrays.
- **New artifacts for review**
  - `src/sim-tools/cli.lua` exposing `parse_argv(argv)` and `dispatch(command, argv, deps)` to bridge shell scripts with harness modules.
  - `scripts/run-room-server.sh` invoking the CLI helper with sane defaults (`--port`, `--room-id`, `--duration`).
  - `scripts/run-room-client.sh` mirroring the server wrapper while passing `--broadcast`, `--udp-port`, and `--duration`.
  - `input/sim-tools/example-room-server.args` capturing a sample argv manifest for documentation and smoke tests.

### Logging & Observability ↔ Existing Code
- `src/sim-tools/logging.lua`
  - Provide a shared helper (`trace(component, action, status, fields)`) that emits structured logs without coupling to runtime HUD state.
- `src/sim-tools/harness/*`
  - Accept optional sink callbacks (e.g. write-to-file, stdout collector) to keep simulator output configurable while remaining independent from `main` scene objects.
- **New artifacts for review**
  - `src/sim-tools/log_sinks.lua` defining CLI-focused sinks (stdout, jsonl file) that can be toggled per harness.
  - `tests/sim-tools/sim_tools_logging_spec.lua` asserting TRACE events are captured through these sinks without invoking UI helpers.

### Runtime ↔ Simulator Isolation Plan
- `main/` collections & scripts
  - Leave untouched; the existing HUD and button flows remain reserved for the actual game experience.
- `src/sim-tools/ui/` (optional future scope)
  - If lightweight simulator status displays are required later, place them under a new namespace to keep parity with the CLI while avoiding reuse of `main/ui` resources.
- Documentation touchpoints
  - Clarify in `docs/spec/sim-tools.md` and README simulator sections that the tooling operates headlessly/CLI-first and does not adjust game UI assets.
- **New artifacts for review**
  - `docs/tasks/2025-10-06-sim-tools.md` checklist entries to verify no runtime UI files change during simulator work.

### Test Coverage & Automation Hooks ↔ Existing Code
- `tests/sim-tools/simulation_created_room_spec.lua`
  - Replace real socket calls with faked transports provided by a new `tests/support/sim_tools_fakes.lua` module so tests can assert `TRACE|sim.server|…` payloads emitted by `run_server_loop`.
  - Add coverage for duration shutdown by simulating SIGINT via a fake `sys.get_exit_requested` dependency.
- `tests/sim-tools/simulation_join_room_spec.lua`
  - Verify that CLI parsing surfaces expected defaults and that discovery retries obey the harness scheduler cadence by injecting fake timers.
- `tests/support/network_context.lua`
  - Extend existing helpers to bootstrap server/client harnesses for specs without duplicating setup logic.
- **New artifacts for review**
  - `tests/support/sim_tools_fakes.lua` exposing `build_fake_socket()`, `build_fake_timer()`, and `collect_trace_logs()` utilities.
  - `tests/sim-tools/simulation_cli_spec.lua` covering happy-path and error-path CLI usage for both simulators.
  - `docs/plan/checklists/sim-tools-validation.md` enumerating automation expectations (duration caps, exit codes, TRACE assertions) referenced by future CI notes.

## Spec / Plan / Task Audit (2025-10-06)
- **Spec alignment**: `docs/spec/sim-tools.md` now enforces CLI-only isolation for simulators and removes any requirement to rename HUD buttons under `main/ui`. Future edits must preserve the no-UI-touch rule and keep terminology scoped to docs/CLI strings.
- **Plan coverage**: The task list above lacks explicit smoke checks. Added Task 7 to ensure `scripts/run-room-*.sh --duration` invocations are documented as the fast shell validation path.
- **Task tracker gaps**: `docs/tasks/2025-10-06-sim-tools.md` needs per-artifact checkboxes and command snippets so reviewers can verify work quickly from a terminal. Update the tracker to reference `./scripts/test.sh tests/sim-tools/...` and the new smoke commands.
- **Follow-up**: Once harness modules land, mirror the audit summary into the task tracker notes to keep future agents aware of the isolation guardrails.

## Coordination
- Track day-to-day progress in `docs/tasks/2025-10-06-sim-tools.md` (spec:sim-tools).
